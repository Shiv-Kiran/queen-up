name: Generate Daily Puzzle

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger secured daily puzzle endpoint
        env:
          DAILY_PUZZLE_ENDPOINT: ${{ secrets.DAILY_PUZZLE_ENDPOINT }}
          PUZZLE_ADMIN_TOKEN: ${{ secrets.PUZZLE_ADMIN_TOKEN }}
        run: |
          if [ -z "$DAILY_PUZZLE_ENDPOINT" ]; then
            echo "Missing DAILY_PUZZLE_ENDPOINT secret"
            exit 1
          fi

          if [ -z "$PUZZLE_ADMIN_TOKEN" ]; then
            echo "Missing PUZZLE_ADMIN_TOKEN secret"
            exit 1
          fi

          status=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "$DAILY_PUZZLE_ENDPOINT" \
            -H "x-admin-token: $PUZZLE_ADMIN_TOKEN" \
            -H "content-type: application/json")

          echo "HTTP status: $status"
          cat response.json

          if [ "$status" -lt 200 ] || [ "$status" -ge 300 ]; then
            echo "Daily puzzle generation failed"
            exit 1
          fi

      - name: Check email config
        id: emailcheck
        run: |
          if [ -n "${{ secrets.SMTP_SERVER }}" ] && \
             [ -n "${{ secrets.SMTP_USERNAME }}" ] && \
             [ -n "${{ secrets.SMTP_PASSWORD }}" ] && \
             [ -n "${{ secrets.NOTIFY_EMAIL_TO }}" ] && \
             [ -n "${{ secrets.NOTIFY_EMAIL_FROM }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Send email notification
        if: ${{ success() && steps.emailcheck.outputs.enabled == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT != '' && secrets.SMTP_PORT || '587' }}
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[Queens Puzzle] Daily Puzzle Generated"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          body: |
            A new daily Queens puzzle was generated successfully.

            Repository: ${{ github.repository }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Trigger time (UTC): ${{ github.event.repository.updated_at }}

      - name: Email notification skipped
        if: ${{ success() && steps.emailcheck.outputs.enabled != 'true' }}
        run: echo "SMTP/notification secrets not fully configured; skipping email."

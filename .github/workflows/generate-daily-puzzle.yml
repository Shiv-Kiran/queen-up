name: Generate Daily Puzzle

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger secured daily puzzle endpoint
        id: generate
        continue-on-error: true
        env:
          DAILY_PUZZLE_ENDPOINT: ${{ secrets.DAILY_PUZZLE_ENDPOINT }}
          PUZZLE_ADMIN_TOKEN: ${{ secrets.PUZZLE_ADMIN_TOKEN }}
        run: |
          if [ -z "$DAILY_PUZZLE_ENDPOINT" ]; then
            echo "Missing DAILY_PUZZLE_ENDPOINT secret"
            exit 1
          fi

          if [ -z "$PUZZLE_ADMIN_TOKEN" ]; then
            echo "Missing PUZZLE_ADMIN_TOKEN secret"
            exit 1
          fi

          status=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "$DAILY_PUZZLE_ENDPOINT" \
            -H "x-admin-token: $PUZZLE_ADMIN_TOKEN" \
            -H "content-type: application/json") || status="000"

          if [ ! -s response.json ]; then
            echo '{"error":"No response body from daily generation endpoint."}' > response.json
          fi

          echo "HTTP status: $status"
          cat response.json
          echo "http_status=$status" >> $GITHUB_OUTPUT

          if [ "$status" -lt 200 ] || [ "$status" -ge 300 ]; then
            echo "Daily puzzle generation failed"
            exit 1
          fi

      - name: Parse generation response
        id: parsed
        if: ${{ always() }}
        shell: bash
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const outputPath = process.env.GITHUB_OUTPUT;

          function clean(value) {
            return String(value ?? '').replace(/\r?\n/g, ' ').trim();
          }

          function setOutput(name, value) {
            fs.appendFileSync(outputPath, `${name}=${clean(value)}\n`);
          }

          let payload = {};
          try {
            payload = JSON.parse(fs.readFileSync('response.json', 'utf8'));
          } catch {
            payload = {};
          }

          const details = payload.details ?? {};
          const stats = payload.stats ?? details.stats ?? {};
          const puzzle =
            payload.puzzle ??
            details.puzzle ??
            (Array.isArray(payload.puzzles) ? payload.puzzles[0] : undefined) ??
            (Array.isArray(details.puzzles) ? details.puzzles[0] : undefined) ??
            {};
          const heuristic = puzzle.difficultyHeuristic ?? puzzle.heuristic ?? {};

          setOutput('created', payload.created ?? details.created ?? 0);
          setOutput('puzzle_id', payload.puzzleId ?? puzzle.id ?? '');
          setOutput('seed', puzzle.seed ?? '');
          setOutput('attempts_used', puzzle.attemptsUsed ?? '');
          setOutput('difficulty', puzzle.difficulty ?? '');
          setOutput('difficulty_score', heuristic.score ?? '');
          setOutput('seeds_tried', stats.seedsTried ?? '');
          setOutput('skipped_attempt_failures', stats.skippedAttemptFailures ?? '');
          setOutput('skipped_duplicate_hashes', stats.skippedDuplicateHashes ?? '');
          setOutput('error_message', payload.error ?? '');
          NODE

      - name: Check email config
        id: emailcheck
        if: ${{ always() }}
        run: |
          if [ -n "${{ secrets.SMTP_SERVER }}" ] && \
             [ -n "${{ secrets.SMTP_USERNAME }}" ] && \
             [ -n "${{ secrets.SMTP_PASSWORD }}" ] && \
             [ -n "${{ secrets.NOTIFY_EMAIL_TO }}" ] && \
             [ -n "${{ secrets.NOTIFY_EMAIL_FROM }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Send success email notification
        if: ${{ always() && steps.emailcheck.outputs.enabled == 'true' && steps.generate.outcome == 'success' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT != '' && secrets.SMTP_PORT || '587' }}
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[Queens Puzzle] Daily Puzzle Generated"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          attachments: response.json
          body: |
            A new daily Queens puzzle was generated successfully.

            Repository: ${{ github.repository }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            HTTP status: ${{ steps.generate.outputs.http_status }}
            Created: ${{ steps.parsed.outputs.created }}
            Puzzle ID: ${{ steps.parsed.outputs.puzzle_id }}
            Seed: ${{ steps.parsed.outputs.seed }}
            Tries (inner attempts): ${{ steps.parsed.outputs.attempts_used }}
            Seeds tried: ${{ steps.parsed.outputs.seeds_tried }}
            Difficulty heuristic: ${{ steps.parsed.outputs.difficulty }} (score ${{ steps.parsed.outputs.difficulty_score }})
            Duplicate hashes skipped: ${{ steps.parsed.outputs.skipped_duplicate_hashes }}
            Per-seed failures skipped: ${{ steps.parsed.outputs.skipped_attempt_failures }}

            Full response is attached as response.json.

      - name: Send failure email notification
        if: ${{ always() && steps.emailcheck.outputs.enabled == 'true' && steps.generate.outcome == 'failure' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT != '' && secrets.SMTP_PORT || '587' }}
          secure: false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[Queens Puzzle] Daily Puzzle Generation Failed"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          attachments: response.json
          body: |
            Daily Queens puzzle generation failed.

            Repository: ${{ github.repository }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            HTTP status: ${{ steps.generate.outputs.http_status }}
            Endpoint error: ${{ steps.parsed.outputs.error_message }}
            Created before failure: ${{ steps.parsed.outputs.created }}
            Puzzle ID (if created): ${{ steps.parsed.outputs.puzzle_id }}
            Seed: ${{ steps.parsed.outputs.seed }}
            Tries (inner attempts): ${{ steps.parsed.outputs.attempts_used }}
            Seeds tried: ${{ steps.parsed.outputs.seeds_tried }}
            Duplicate hashes skipped: ${{ steps.parsed.outputs.skipped_duplicate_hashes }}
            Per-seed failures skipped: ${{ steps.parsed.outputs.skipped_attempt_failures }}

            Full endpoint response is attached as response.json.

      - name: Email notification skipped
        if: ${{ always() && steps.emailcheck.outputs.enabled != 'true' }}
        run: echo "SMTP/notification secrets not fully configured; skipping email."

      - name: Fail workflow if generation failed
        if: ${{ steps.generate.outcome == 'failure' }}
        run: exit 1
